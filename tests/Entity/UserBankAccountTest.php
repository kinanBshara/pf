<?php

namespace App\Tests\Entity;

use App\Entity\UserBankAccount;
use App\Kernel;
use App\Service\EmailService;
use App\Service\TransactionService;
use Doctrine\ORM\EntityManagerInterface;
use PHPUnit\Framework\TestCase;
use Symfony\Bridge\Doctrine\ManagerRegistry;

class UserBankAccountTest extends TestCase
{
    private TransactionService $transactionService;

    protected function setUp(): void
    {
        // Start mocking
        $emailServiceMock = $this->getMockBuilder(EmailService::class)
            ->disableOriginalConstructor()
            ->getMock();
        // End mocking
        $this->transactionService = new TransactionService($emailServiceMock);


        parent::setUp(); // TODO: Change the autogenerated stub
    }

    /**
     * @dataProvider  getUserBankAccountDataProvider
     */
    public function testUserBankAccountTransactions(
        UserBankAccount $userBankAccount,
        int $amount,
        int $expected,
        string $transactionType
    )
    {
        $result = match($transactionType) {
            UserBankAccount::TRANSACTION_DEBIT => $this->transactionService->debit($amount, $userBankAccount),
            UserBankAccount::TRANSACTION_CREDIT => $this->transactionService->credit($amount, $userBankAccount)
        };
        $this->assertEquals($expected, $result);
    }

    public function getUserBankAccountDataProvider()
    {
        # Credit +200
        $userBankAccount1 = new UserBankAccount();
        $userBankAccount1
            ->setFullName('AmÃ©lie')
            ->setEmail('amelie@test.com')
            ->setBalance(400);

            $amount = 200;
            $expected = 200;
            yield[$userBankAccount1, $amount, $expected, UserBankAccount::TRANSACTION_CREDIT];

        # Debit -150
        $userBankAccount2 = new UserBankAccount();
        $userBankAccount2
            ->setFullName('Thomas')
            ->setEmail('thomas@test.com')
            ->setBalance(100);

        $amount2 = 150;
        $expected2 = 100;
        yield[$userBankAccount2, $amount2, $expected2, UserBankAccount::TRANSACTION_DEBIT];


        # Credit +300
        $userBankAccount3 = new UserBankAccount();
        $userBankAccount3
            ->setFullName('Ashley')
            ->setEmail('ashley@test.com')
            ->setBalance(900);

        $amount3 = 300;
        $expected3 = 100;
        yield[$userBankAccount3, $amount3, $expected3, UserBankAccount::TRANSACTION_CREDIT];


        # Debit -750
        $userBankAccount4 = new UserBankAccount();
        $userBankAccount4
            ->setFullName('Tom')
            ->setEmail('tom@test.com')
            ->setBalance(600);

        $amount4 = 750;
        $expected4 = 600;
        yield[$userBankAccount4, $amount4, $expected4, UserBankAccount::TRANSACTION_DEBIT];
    }


    public function testIsTimeToSendEmail()
    {
        $result = $this->transactionService->isTimeToSendEmail();
        $expected = false;

        $this->assertEquals($expected, $result);
    }

}
